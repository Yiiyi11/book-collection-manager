<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Collection Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="container mt-4">
  <!-- Page Title & Operation Area -->
  <header class="mb-4">
    <h1 class="text-center mb-3">My Book Collection</h1>
    <div class="d-flex justify-content-between align-items-center">
      <a href="add-book.html" class="btn btn-success">Add New Book</a>
      <a href="export.html" class="btn btn-info">Export Book List</a>
    </div>
    <div class="card p-3 mb-4">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by title or author...">
        </div>
        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">All Reading Status</option>
            <option value="Read">Read</option>
            <option value="Unread">Unread</option>
            <option value="Reading">Reading</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="categoryFilter" class="form-select">
            <option value="">All Categories</option>
            <option value="Literature">Literature</option>
            <option value="Science Fiction">Science Fiction</option>
            <option value="History">History</option>
            <option value="Popular Science">Popular Science</option>
          </select>
        </div>
        <div class="col-md-2">
          <button id="resetFilter" class="btn btn-outline-secondary w-100">Reset Filters</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Book List Area -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Book Inventory</h5>
      <div id="bookList" class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Book Title</th>
              <th>Author</th>
              <th>ISBN</th>
              <th>Reading Status</th>
              <th>Category</th>
              <th>Added Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bookTableBody">
            <!-- Book data will be dynamically generated via JavaScript -->
            <tr>
              <td colspan="7" class="text-center text-muted">No book data available. Click "Add New Book" to input books.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Import Data Storage Module and Render List -->
  <script type="module">
    import { getAllBooks, deleteBook } from './js/data-storage.js';
    import { filterBooks } from './js/search.js'; // Import filter function

    // Render function, supports passing filtered book list
    function renderBookList(booksToRender) {
      const tableBody = document.getElementById('bookTableBody');
      tableBody.innerHTML = '';
      
      if (booksToRender.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">No matching book data found</td>
          </tr>
        `;
        return;
      }
      
      // Dynamically generate book rows
      booksToRender.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.isbn}</td>
          <td>
            <span class="badge ${
              book.status === 'Read' ? 'bg-success' : 
              book.status === 'Reading' ? 'bg-warning' : 'bg-secondary'
            }">${book.status}</span>
          </td>
          <td>${book.category}</td>
          <td>${book.addTime}</td>
          <td>
            <button class="btn btn-danger btn-sm delete-btn" data-isbn="${book.isbn}">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // Bind delete button event
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const isbn = e.target.getAttribute('data-isbn');
          if (deleteBook(isbn)) {
            // Re-apply filters after successful deletion
            applyFilters();
          }
        });
      });
    }
    
    // Filter logic
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      const filteredBooks = filterBooks(searchTerm, statusFilter, categoryFilter);
      renderBookList(filteredBooks);
    }
    
    // Bind filter events when page loads
    window.onload = () => {
      // Initial render of all books
      renderBookList(getAllBooks());
      
      // Real-time filtering on search input
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      
      // Dropdown selection change events
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
      
      // Reset filter button event
      document.getElementById('resetFilter').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        renderBookList(getAllBooks()); // Reset to show all books
      });
    };
  </script>
</body>
</html>