<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Collection Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body class="container mt-4">

  <header class="mb-4">
    <h1 class="text-center mb-3">My Book Collection</h1>
    <div class="d-flex justify-content-between align-items-center">
      <a href="add-book.html" class="btn btn-success">Add New Book</a>
      <a href="export.html" class="btn btn-info">Export Book List</a>
    </div>
    <div class="card p-3 mb-4">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by title or author...">
        </div>
        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">All Reading Status</option>
            <option value="Read">Read</option>
            <option value="Unread">Unread</option>
            <option value="Reading">Reading</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="categoryFilter" class="form-select">
            <option value="">All Categories</option>
            <option value="Literature">Literature</option>
            <option value="Science Fiction">Science Fiction</option>
            <option value="History">History</option>
            <option value="Popular Science">Popular Science</option>
          </select>
        </div>
        <div class="col-md-2">
          <button id="resetFilter" class="btn btn-outline-secondary w-100">Reset Filters</button>
        </div>
      </div>
    </div>
  </header>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Book Inventory</h5>

      <div id="bookList" class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Book Title</th>
              <th>Author</th>
              <th>ISBN</th>
              <th>Reading Status</th>
              <th>Category</th>
              <th>Added Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bookTableBody">
            <tr>
              <td colspan="7" class="text-center text-muted">No book data available. Click "Add New Book" to input books.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script type="module">
    import { getAllBooks, deleteBook } from './js/data-storage.js';
    import { filterBooks } from './js/search.js';

    function renderBookList(booksToRender) {
      const tableBody = document.getElementById('bookTableBody');
      tableBody.innerHTML = '';
      
      if (booksToRender.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">No matching book data found</td>
          </tr>
        `;
        return;
      }

      booksToRender.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.isbn}</td>
          <td>
            <span class="badge ${
              book.status === 'Read' ? 'bg-success' : 
              book.status === 'Reading' ? 'bg-warning' : 'bg-secondary'
            }">${book.status}</span>
          </td>
          <td>${book.category}</td>
          <td>${book.addTime}</td>
          <td>
            <button class="btn btn-danger btn-sm delete-btn" data-isbn="${book.isbn}">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const isbn = e.target.getAttribute('data-isbn');
          if (await deleteBook(isbn)) {  // 假设deleteBook也是异步函数，这里一并处理
            applyFilters();
          }
        });
      });
    }

    async function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      const allBooks = await getAllBooks();  // 等待获取所有书籍
      const filteredBooks = filterBooks(allBooks, searchTerm, statusFilter, categoryFilter);
      renderBookList(filteredBooks);
    }
    
    window.onload = async () => {  // 使用async函数
      // 初始加载时获取并渲染所有书籍
      const allBooks = await getAllBooks();
      renderBookList(allBooks);
      
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
      document.getElementById('resetFilter').addEventListener('click', async () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        const allBooks = await getAllBooks();  // 重新获取所有书籍
        renderBookList(allBooks);
      });

      // 添加storage事件监听
      window.addEventListener('storage', applyFilters);
    };
  </script>
</body>
</html>